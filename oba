#!/bin/sh

function rmapp {
  if [[ -d "/Applications/OneBusAway.app/" ]]; then
    CUR_DIR=`pwd`

    echo "Removing current app..."
    cd /Applications
    rm -Rf OneBusAway.app

    cd $CUR_DIR
  fi
}

function dorestart {
  read -p "Restart required. Restart now? (y/n) " -n 1
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
       reboot
  fi
}

# make sure only root can run our script
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 1>&2
   exit -1
fi

if [[ $# -ge 1 ]];
then
  if [[ $1 = "rm" ]];
  then
    rmapp
    dorestart
    exit 0
  fi
fi

mkdir temp
cd temp

###
echo "Downloading app..."
#use LOk if you want to save file
if [[ $# -ge 1 ]];
then
  curl -Lk https://github.com/bbodenmiller/onebusaway-iphone-test-releases/archive/$1.tar.gz | tar -xz
else
  curl -Lk https://github.com/bbodenmiller/onebusaway-iphone-test-releases/archive/dev.tar.gz | tar -xz
fi

SOURCE=`find . -name "onebusaway-iphone-test-releases*"`

if [[ ! -d $SOURCE ]]; then
  echo "An error occured, no changes have been made"
  exit -1
fi

###
rmapp

###
echo "Installing app..."
cp -R ./$SOURCE/OneBusAway.app /Applications/OneBusAway.app

cd ..

###
echo "Cleanup..."
rm -R temp

###
dorestart
